<div class="input-label">Namen eingeben</div>
<ng-select [items]="people$ | async"
           placeholder="Name: "
           bindLabel="name"
           [addTag]="true"
           [multiple]="false"
           [hideSelected]="true"
           [trackByFn]="trackByFn"
           [minTermLength]="2"
           [loading]="peopleLoading"
           i18n-typeToSearchText="@@typeToSearchText"
           typeToSearchText="Bitte gib mindestens zwei Zeichen ein"
           i18n-addTagText="@@addTagText"
           addTagText="Hinzufügen"
           [typeahead]="peopleInput$"
           [(ngModel)]="selectedPerson"
           (blur)="selected($event)"
           (change)="change($event)"
           #searchBar
           class="name-input-container"></ng-select>
           

<!-- If this is the place 'new' editor, show a map and explicit 'Keine Person ausgewählt' message -->
@if (isPlaceNew) {
  <div class="place-new-map">
    @defer {
      <app-map-select (locationSelected)="onMapLocationSelected($event)"></app-map-select>
    } @placeholder {
      <div class="map-placeholder">Karte konnte nicht geladen werden.</div>
    } @loading {
      <div class="map-loading">Lade Karte...</div>
    }
  </div>

  <h2 class="selected-person-title">Keine Person ausgewählt</h2>
} @else {
  <h2 class="selected-person-title">{{ personName || selectedPerson?.name || 'Keine Person' }} ausgewählt</h2>
}

<div class="fields-container">
  <!-- Dynamische Felder -->
  <div class="person-header">
    <mat-form-field class="full-width small-name-field">
      <mat-label>Name</mat-label>
      <input matInput [(ngModel)]="personName" (blur)="onNameBlur()">
    </mat-form-field>
  </div>

  <app-field *ngFor="let field of personData" [field]="field" (saved)="onFieldSaved($event, field)"></app-field>

  <!-- Relationships Section -->
  @if (personFull() && personFull()?.relationships && personFull()!.relationships!.length > 0) {
    <div class="relationships-section">
      <h3 class="section-title">
        <mat-icon>people</mat-icon>
        Beziehungen
      </h3>
      <div class="relationships-list">
        @for (rel of personFull()!.relationships; track rel.relationshipId) {
          <div class="relationship-card" (click)="navigateToRelatedPerson(rel)">
            <div class="relationship-info">
              <span class="relationship-type">{{ rel.relationType }}</span>
              <span class="relationship-person">{{ rel.relatedPersonName }}</span>
            </div>
            @if (rel.startDate || rel.endDate) {
              <div class="relationship-dates">
                @if (rel.startDate) {
                  <span>{{ rel.startDate | date: 'yyyy' }}</span>
                }
                @if (rel.startDate && rel.endDate) {
                  <span> - </span>
                }
                @if (rel.endDate) {
                  <span>{{ rel.endDate | date: 'yyyy' }}</span>
                }
              </div>
            }
            <mat-icon class="relationship-arrow">arrow_forward</mat-icon>
          </div>
        }
      </div>
      <button mat-button color="primary" (click)="addRelationship()" class="add-relationship-btn">
        <mat-icon>add</mat-icon>
        Beziehung hinzufügen
      </button>
    </div>
  } @else if (selectedPerson?.id) {
    <div class="relationships-section">
      <h3 class="section-title">
        <mat-icon>people</mat-icon>
        Beziehungen
      </h3>
      <p class="no-relationships">Noch keine Beziehungen</p>
      <button mat-button color="primary" (click)="addRelationship()" class="add-relationship-btn">
        <mat-icon>add</mat-icon>
        Beziehung hinzufügen
      </button>
    </div>
  }

  <!-- Neues Feld mit Autovervollständigung -->
  <mat-form-field class="full-width">
    <mat-label>Neues Feld</mat-label>
    <input type="text"
           placeholder="Auswählen/Eingeben"
           aria-label="Neues Feld"
           matInput
           [formControl]="newFieldControl"
           [matAutocomplete]="auto">
    <mat-autocomplete #auto="matAutocomplete">
      <mat-option *ngFor="let option of options" 
                  [value]="option" 
                  (click)="addNamedField(option)">
        {{ option }}
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>
</div>

<!-- Button unten rechts -->
<div class="editor-actions">
  <button mat-flat-button color="primary" (click)="saveAll()">Save All</button>
  <button mat-button class="add-field-button" (click)="addField()">Hinzufügen</button>
</div>
