<div class="relationship-editor-container">
  <!-- Error/Success Messages -->
  @if (errorMessage()) {
    <div class="message-banner error-banner">
      <mat-icon>error</mat-icon>
      <span>{{ errorMessage() }}</span>
      <button mat-icon-button (click)="clearMessages()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  <!-- Delete Confirmation Dialog -->
  @if (showDeleteConfirm()) {
    <div class="delete-overlay">
      <mat-card class="delete-confirm-card">
        <mat-card-content>
          <mat-icon class="warn-icon">warning</mat-icon>
          <h3>Beziehung löschen?</h3>
          <p>Diese Aktion kann nicht rückgängig gemacht werden.</p>
          <div class="confirm-actions">
            <button mat-button (click)="cancelDelete()">Abbrechen</button>
            <button mat-raised-button color="warn" (click)="deleteRelationship()">
              <mat-icon>delete</mat-icon>
              Löschen
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  }

  <div class="header">
    <h1 class="page-title">
      @if (relationshipId && relationshipId !== 'new') {
        Beziehung bearbeiten
      } @else {
        Neue Beziehung
      }
    </h1>
    <div class="header-actions">
      <button mat-button (click)="cancel()" matTooltip="Escape">
        <mat-icon>close</mat-icon>
        <span class="button-text">Abbrechen</span>
      </button>
      @if (relationshipId && relationshipId !== 'new') {
        <button mat-button color="warn" (click)="confirmDelete()">
          <mat-icon>delete</mat-icon>
          <span class="button-text">Löschen</span>
        </button>
      }
      <button mat-raised-button color="primary" (click)="save()" [disabled]="saving()" matTooltip="Strg+S">
        <mat-icon>{{ saving() ? 'hourglass_empty' : 'save' }}</mat-icon>
        <span class="button-text">
          @if (saving()) {
            Speichert...
          } @else {
            Speichern
          }
        </span>
      </button>
    </div>
  </div>

  @if (loading()) {
    <mat-card>
      <mat-card-content>
        <div class="loading-state">Lädt...</div>
      </mat-card-content>
    </mat-card>
  } @else {
    <mat-card class="editor-card">
      <mat-card-content>
        <div class="form-section">
          <h2 class="section-title">
            <mat-icon>people</mat-icon>
            Personen
          </h2>
          
          <div class="person-fields">
            <div class="person-field">
              <label class="field-label" [class.error]="showValidation() && !fromPersonId">Von Person *</label>
              <ng-select
                [(ngModel)]="fromPersonId"
                [items]="fromPersonResults$()"
                bindLabel="name"
                bindValue="id"
                [typeahead]="fromPersonSearch$"
                [loading]="loadingFromPerson()"
                [addTag]="addPersonTag"
                addTagText="Neue Person erstellen: "
                placeholder="Person suchen..."
                [class.invalid]="showValidation() && !fromPersonId"
                class="person-select">
                <ng-template ng-option-tmp let-item="item">
                  <div class="person-option">
                    <mat-icon class="person-icon">{{ item._isNew ? 'person_add' : 'person' }}</mat-icon>
                    <span>{{ item.name }}</span>
                    @if (item._isNew) {
                      <span class="new-badge">Neu</span>
                    }
                  </div>
                </ng-template>
              </ng-select>
              @if (showValidation() && !fromPersonId) {
                <div class="field-error">Bitte wählen Sie eine Person aus</div>
              }
            </div>

            <div class="relationship-arrow">
              <button mat-icon-button 
                      (click)="swapPersons()" 
                      matTooltip="Personen tauschen"
                      class="swap-button">
                <mat-icon>swap_horiz</mat-icon>
              </button>
            </div>

            <div class="person-field">
              <label class="field-label" [class.error]="showValidation() && !toPersonId">Zu Person *</label>
              <ng-select
                [(ngModel)]="toPersonId"
                [items]="toPersonResults$()"
                bindLabel="name"
                bindValue="id"
                [typeahead]="toPersonSearch$"
                [loading]="loadingToPerson()"
                [addTag]="addPersonTag"
                addTagText="Neue Person erstellen: "
                placeholder="Person suchen..."
                [class.invalid]="showValidation() && !toPersonId"
                class="person-select">
                <ng-template ng-option-tmp let-item="item">
                  <div class="person-option">
                    <mat-icon class="person-icon">{{ item._isNew ? 'person_add' : 'person' }}</mat-icon>
                    <span>{{ item.name }}</span>
                    @if (item._isNew) {
                      <span class="new-badge">Neu</span>
                    }
                  </div>
                </ng-template>
              </ng-select>
              @if (showValidation() && !toPersonId) {
                <div class="field-error">Bitte wählen Sie eine Person aus</div>
              }
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">
            <mat-icon>label</mat-icon>
            Beziehungstyp
          </h2>
          
          <!-- Quick type buttons -->
          <div class="quick-types">
            @for (type of quickTypes; track type.value) {
              <button 
                mat-stroked-button 
                [class.active]="relationshipType === type.value"
                (click)="setQuickType(type.value)"
                class="quick-type-btn">
                <mat-icon>{{ type.icon }}</mat-icon>
                {{ type.label }}
              </button>
            }
          </div>

          <mat-form-field appearance="outline" class="full-width" [class.invalid]="showValidation() && !relationshipType">
            <mat-label>Beziehungstyp *</mat-label>
            <input 
              matInput 
              [(ngModel)]="relationshipType"
              [matAutocomplete]="auto"
              placeholder="z.B. Vater, Freund, Chef...">
            <mat-autocomplete #auto="matAutocomplete">
              @for (type of relationshipTypes; track type.value) {
                <mat-option [value]="type.value">
                  {{ type.label }}
                </mat-option>
              }
            </mat-autocomplete>
            @if (showValidation() && !relationshipType) {
              <mat-error>Bitte geben Sie einen Beziehungstyp an</mat-error>
            } @else {
              <mat-hint>Wählen Sie einen vordefinierten Typ oder geben Sie einen eigenen ein</mat-hint>
            }
          </mat-form-field>
        </div>

        <div class="form-section">
          <h2 class="section-title">
            <mat-icon>event</mat-icon>
            Zeitraum
          </h2>
          
          <div class="date-fields">
            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Startdatum</mat-label>
              <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
              <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="date-field">
              <mat-label>Enddatum</mat-label>
              <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
              <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
              <mat-hint>Optional - leer lassen für aktuelle Beziehungen</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">
            <mat-icon>verified</mat-icon>
            Sicherheit
          </h2>
          
          <div class="certainty-field">
            <label class="field-label">Sicherheit: {{ certainty }}%</label>
            <mat-slider 
              min="0" 
              max="100" 
              step="5" 
              discrete
              [displayWith]="formatLabel">
              <input matSliderThumb [(ngModel)]="certainty">
            </mat-slider>
            <div class="certainty-hint">
              Wie sicher sind Sie über diese Beziehung?
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">
            <mat-icon>notes</mat-icon>
            Notizen
          </h2>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notizen</mat-label>
            <textarea 
              matInput 
              [(ngModel)]="notes"
              rows="4"
              placeholder="Zusätzliche Informationen zur Beziehung..."></textarea>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
